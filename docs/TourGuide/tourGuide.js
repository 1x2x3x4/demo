export default class TourGuide{constructor(t){this.steps=t||[],this.index=0,this.overlayEl=null,this.popEl=null,this.titleEl=null,this.descEl=null,this.cloneEl=null,this.maskEl=null,this.DISTANCE=16,this.VW=window.innerWidth||document.documentElement.clientWidth,this.VH=window.innerHeight||document.documentElement.clientHeight}static async from(t="TourGuide/config.json"){const e=await fetch(t).then((t=>t.json()));return new TourGuide(e)}start(){this.#e().#t(0)}next(){this.#t(this.index+1)}prev(){this.#t(this.index-1)}skip(){this.#i()}#t(t){if(t<0||!this.steps[t])return this.#i();this.#s(),this.index=t;const e=this.steps[t];this.titleEl.textContent=e.title,this.descEl.innerHTML=e.content;const i=document.querySelector(e.target);if(e.position)if(this.#n(e.position.left,e.position.top),e.clip&&i)if(e.highlight)this.#o(e.highlight);else{const t=i.getBoundingClientRect();this.#o(t)}else this.overlayEl.style.background="none";else{if(i&&e.click&&i.click(),i&&!this.#l(i))return i.scrollIntoView({behavior:"smooth",block:"center"}),void setTimeout((()=>{this.#h(i,!!e.clip)}),500);this.#h(i,!!e.clip)}const s=t===this.steps.length-1,n=0===t;this.overlayEl.querySelector(".next").textContent=s?"完成":"下一步",this.overlayEl.querySelector(".exit").style.display=s?"none":"",this.overlayEl.querySelector(".prev").style.display=n?"none":"",this.#r(e)}#h(t,e,i){if(this.#s(),!t)return this.#n(this.VW/2,this.VH/2);this.#l(t)||t.scrollIntoView({behavior:"smooth",block:"center"});const s=t.getBoundingClientRect(),n=this.popEl.getBoundingClientRect(),o=s.left,l=this.VW-s.right,h=(s.top,this.VH-s.bottom);let r,c=s.top;o>=n.width||l>=n.width?r=s.x+s.width/2<this.VW/2&&l>=n.width?s.right+this.DISTANCE:s.left-n.width-this.DISTANCE:h>=n.height?(c=s.bottom+this.DISTANCE,r=Math.min(Math.max(this.DISTANCE,s.left),this.VW-n.width-this.DISTANCE)):(c=this.VH-n.height-this.DISTANCE,r=this.VW-n.width-this.DISTANCE),this.#n(r,c),e&&(i?this.#o(i):this.#o(s))}#n(t,e){this.popEl.style.left=Math.max(this.DISTANCE,Math.min(t,this.VW-this.popEl.offsetWidth-this.DISTANCE))+"px",this.popEl.style.top=Math.max(this.DISTANCE,Math.min(e,this.VH-this.popEl.offsetHeight-this.DISTANCE))+"px"}#s(){this.cloneEl?.remove(),this.cloneEl=null,this.maskEl&&(this.maskEl.remove(),this.maskEl=null)}#o(t){let e;this.maskEl=document.createElement("div"),this.maskEl.className="tour-guide-mask",document.body.appendChild(this.maskEl),e="object"==typeof t?{left:void 0!==t.left?t.left:t.x||0,top:void 0!==t.top?t.top:t.y||0,width:t.width||100,height:t.height||100}:{left:this.VW/2-50,top:this.VH/2-50,width:100,height:100};const i=`tour-mask-${Date.now()}`,s=`\n      <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n        <defs>\n          <mask id="${i}">\n            <rect width="100%" height="100%" fill="white"/>\n            <rect x="${e.left}" y="${e.top}" \n                  width="${e.width}" height="${e.height}" \n                  rx="4" ry="4" fill="black"/>\n          </mask>\n        </defs>\n        <rect width="100%" height="100%" fill="rgba(0,0,0,0.5)" mask="url(#${i})"/>\n      </svg>\n    `;this.maskEl.innerHTML=s,this.cloneEl=document.createElement("div"),Object.assign(this.cloneEl.style,{position:"fixed",top:e.top+"px",left:e.left+"px",width:e.width+"px",height:e.height+"px",border:"1px solid #1a73e8",borderRadius:"4px",boxShadow:"0 0 0 4px rgba(26, 115, 232, 0.3)",zIndex:1e4,pointerEvents:"none"}),document.body.appendChild(this.cloneEl)}#e(){const t=document.createElement("div");return t.innerHTML='\n      <div id="introduce" style="position:fixed;inset:0;">\n        <div class="introduce-box">\n          <p class="introduce-title"></p>\n          <p class="introduce-desc"></p>\n          <div class="introduce-operate">\n            <button class="exit">跳过</button>\n            <button class="prev">上一步</button>\n            <button class="next">下一步</button>\n          </div>\n        </div>\n      </div>',this.overlayEl=t.firstElementChild,document.body.prepend(this.overlayEl),this.popEl=this.overlayEl.querySelector(".introduce-box"),this.titleEl=this.overlayEl.querySelector(".introduce-title"),this.descEl=this.overlayEl.querySelector(".introduce-desc"),this.overlayEl.querySelector(".next").onclick=()=>this.next(),this.overlayEl.querySelector(".prev").onclick=()=>this.prev(),this.overlayEl.querySelector(".exit").onclick=()=>this.skip(),this}#l(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.right<=this.VW&&e.bottom<=this.VH}#i(){this.#s(),this.overlayEl?.remove(),this.#c()}#c(){const t=document.querySelector("#app")?.__vue__;t&&(t.setExpStep("calibration"),"sine"!==t.signalType&&t.setSignalType("sine"),t.$set(t.inputActive,1,!1),t.$set(t.inputActive,2,!1),t.displayMode="independent",t.timeDiv=1,t.voltsDiv={1:1,2:1},t.horizontalPosition=0,t.verticalPosition={1:0,2:0},t.peakValues={1:1,2:1},t.frequencies={1:1,2:1},t.triggerLevel=0,t.isRunning||t.toggleRunning(),t.needsRedraw=!0,"function"==typeof t.refreshDisplay&&t.refreshDisplay())}#r(t){const e=document.querySelector("#app")?.__vue__;if(!e)return;const i=()=>{e.inputActive[1]||e.inputActive[2]||e.toggleInput(1)};switch(t.target){case".calibration-panel":case".slider-container":"calibration"!==e.expStep&&e.setExpStep("calibration"),i();break;case".wave-select":case".parameter-control":case".display-mode-switcher":"normal"!==e.expStep&&e.setExpStep("normal"),i();break;case"#lissajous-mode-btn":"normal"!==e.expStep&&e.setExpStep("normal"),e.inputActive[1]||e.toggleInput(1),e.inputActive[2]||e.toggleInput(2);const s=document.querySelector("#lissajous-mode-btn");s&&(s.click(),setTimeout((()=>{const e=document.querySelector(t.target);if(e){this.#s();const t=e.getBoundingClientRect();this.#o(t)}}),10))}t.content.includes("频率比")&&t.content.includes("1:2")&&e.frequencies&&(e.frequencies[1]=1,e.frequencies[2]=2,e.needsRedraw=!0)}}window.TourGuide={init:async function(){(await TourGuide.from()).start()}},document.addEventListener("DOMContentLoaded",(function(){const t=localStorage.getItem("tourGuideAutoStart");"true"!==t&&null!==t||setTimeout((async()=>{(await TourGuide.from()).start()}),1e3)}));